name: 'Release VSCode Extension'
description: 'Downloads binaries, organizes them for extension, and publishes to VS Code Marketplace and Open VSX'

inputs:
  azure-pat:
    description: 'Azure DevOps Personal Access Token for VS Code Marketplace'
    required: true
  open-vsx-pat:
    description: 'Personal Access Token for Open VSX Registry'
    required: true

runs:
  using: 'composite'
  steps:
    - name: Download all binaries
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Build shared dependencies
      shell: bash
      run: pnpm turbo run build --filter=tscanner-common

    - name: Organize binaries for extension
      shell: bash
      run: |
        mkdir -p packages/vscode-extension/out/binaries
        find artifacts -type f -name 'tscanner-server-*' -exec cp {} packages/vscode-extension/out/binaries/ \;
        chmod +x packages/vscode-extension/out/binaries/tscanner-server-* 2>/dev/null || true
        echo "ðŸ“¦ Binaries ready for extension:"
        ls -lah packages/vscode-extension/out/binaries/

    - name: Get version
      id: version
      shell: bash
      run: |
        VERSION=$(node -p "require('./packages/vscode-extension/package.json').version")
        echo "current=$VERSION" >> $GITHUB_OUTPUT
        echo "ðŸ“¦ Publishing version: $VERSION"

    - name: Publish to Open VSX Registry
      id: publishToOpenVSX
      uses: HaaLeo/publish-vscode-extension@v2
      with:
        pat: ${{ inputs.open-vsx-pat }}
        packagePath: ./packages/vscode-extension
        dependencies: false
        skipDuplicate: true

    - name: Publish to VS Code Marketplace
      uses: HaaLeo/publish-vscode-extension@v2
      with:
        pat: ${{ inputs.azure-pat }}
        registryUrl: https://marketplace.visualstudio.com
        extensionFile: ${{ steps.publishToOpenVSX.outputs.vsixPath }}
        dependencies: false
        skipDuplicate: true

    - name: Create release tag
      shell: bash
      run: bash scripts/release/create-release-tag.sh "vscode-extension" "${{ steps.version.outputs.current }}"

    - name: Summary
      shell: bash
      run: echo "âœ… VSCode extension v${{ steps.version.outputs.current }} published to both marketplaces!"
