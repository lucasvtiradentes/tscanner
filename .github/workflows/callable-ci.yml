name: 'Callable CI'

on:
  workflow_call:
    inputs:
      run_lint:
        description: 'Run lint checks'
        type: boolean
        required: true
      run_build:
        description: 'Run build'
        type: boolean
        required: true
    outputs:
      should_release:
        description: 'Whether any version was bumped and should trigger release'
        value: ${{ jobs.check_version.outputs.should_release }}
      should_release_npm:
        description: 'Whether CLI/NPM package version was bumped'
        value: ${{ jobs.check_version.outputs.should_release_npm }}
      should_release_vscode:
        description: 'Whether VSCode extension version was bumped'
        value: ${{ jobs.check_version.outputs.should_release_vscode }}
      should_release_github_action:
        description: 'Whether GitHub Action version was bumped'
        value: ${{ jobs.check_version.outputs.should_release_github_action }}
    secrets:
      TURBO_TOKEN:
        description: Turbo token for cache
        required: true
      TURBO_TEAM:
        description: Turbo team for cache
        required: true

env:
  CARGO_TERM_COLOR: always
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ secrets.TURBO_TEAM }}

jobs:
  check_version:
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      should_release_npm: ${{ steps.check.outputs.should_release_npm }}
      should_release_vscode: ${{ steps.check.outputs.should_release_vscode }}
      should_release_github_action: ${{ steps.check.outputs.should_release_github_action }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check if version was bumped
        id: check
        run: |
          echo "ðŸ” Changed files:"
          git diff --name-only HEAD^ HEAD || echo "  (none - initial commit)"
          echo ""

          SHOULD_RELEASE_NPM="false"
          SHOULD_RELEASE_VSCODE="false"
          SHOULD_RELEASE_GITHUB_ACTION="false"

          # Check CLI/NPM package
          CLI_PKG="packages/cli/package.json"
          CLI_CURRENT=$(node -p "require('./$CLI_PKG').version")
          CLI_PREVIOUS=$(git show HEAD^:./$CLI_PKG 2>/dev/null | node -p "try { JSON.parse(require('fs').readFileSync('/dev/stdin', 'utf-8')).version } catch(e) { '' }" || echo "")

          echo "ðŸ” CLI/NPM: $CLI_PREVIOUS â†’ $CLI_CURRENT"
          if [ -n "$CLI_PREVIOUS" ] && [ "$CLI_PREVIOUS" != "$CLI_CURRENT" ]; then
            echo "âœ… CLI/NPM version bumped"
            SHOULD_RELEASE_NPM="true"
          fi

          # Check VSCode extension
          VSCODE_PKG="packages/vscode-extension/package.json"
          VSCODE_CURRENT=$(node -p "require('./$VSCODE_PKG').version")
          VSCODE_PREVIOUS=$(git show HEAD^:./$VSCODE_PKG 2>/dev/null | node -p "try { JSON.parse(require('fs').readFileSync('/dev/stdin', 'utf-8')).version } catch(e) { '' }" || echo "")

          echo "ðŸ” VSCode Extension: $VSCODE_PREVIOUS â†’ $VSCODE_CURRENT"
          if [ -n "$VSCODE_PREVIOUS" ] && [ "$VSCODE_PREVIOUS" != "$VSCODE_CURRENT" ]; then
            echo "âœ… VSCode extension version bumped"
            SHOULD_RELEASE_VSCODE="true"
          fi

          # Check GitHub Action
          ACTION_PKG="packages/github-action/package.json"
          ACTION_CURRENT=$(node -p "require('./$ACTION_PKG').version")
          ACTION_PREVIOUS=$(git show HEAD^:./$ACTION_PKG 2>/dev/null | node -p "try { JSON.parse(require('fs').readFileSync('/dev/stdin', 'utf-8')).version } catch(e) { '' }" || echo "")

          echo "ðŸ” GitHub Action: $ACTION_PREVIOUS â†’ $ACTION_CURRENT"
          if [ -n "$ACTION_PREVIOUS" ] && [ "$ACTION_PREVIOUS" != "$ACTION_CURRENT" ]; then
            echo "âœ… GitHub Action version bumped"
            SHOULD_RELEASE_GITHUB_ACTION="true"
          fi

          echo ""
          echo "should_release_npm=$SHOULD_RELEASE_NPM" >> $GITHUB_OUTPUT
          echo "should_release_vscode=$SHOULD_RELEASE_VSCODE" >> $GITHUB_OUTPUT
          echo "should_release_github_action=$SHOULD_RELEASE_GITHUB_ACTION" >> $GITHUB_OUTPUT

          if [ "$SHOULD_RELEASE_NPM" = "true" ] || [ "$SHOULD_RELEASE_VSCODE" = "true" ]; then
            echo "âœ… Building binaries (version bumped)"
            echo "should_release=true" >> $GITHUB_OUTPUT
          else
            echo "â­ï¸  No version bump, skipping binary build"
            echo "should_release=false" >> $GITHUB_OUTPUT
          fi

  lint:
    if: inputs.run_lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-and-install

      - name: Run lint
        run: pnpm run lint

      - name: Run format
        run: pnpm run format

      - name: Check if any changes were made
        run: git diff --exit-code

  rust-check:
    if: inputs.run_lint || inputs.run_build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: packages/core
          shared-key: rust-check

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.22.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install turbo only
        run: pnpm add -g turbo

      - name: Run tests and lint (dev profile)
        if: inputs.run_lint
        run: |
          turbo run test --filter=core
          turbo run clippy --filter=core
          turbo run format:check --filter=core

      - name: Build release
        if: inputs.run_build
        run: turbo run build --filter=core

  build:
    if: inputs.run_build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-and-install

      - name: Run typecheck
        run: pnpm run typecheck

      - name: Build package
        run: pnpm run build
