name: 'Callable CI'

on:
  workflow_call:
    inputs:
      run_lint:
        description: 'Run lint checks'
        type: boolean
        required: true
      run_build:
        description: 'Run build'
        type: boolean
        required: true
    outputs:
      should_release:
        description: 'Whether version was bumped and should trigger release'
        value: ${{ jobs.check_version.outputs.should_build }}
    secrets:
      TURBO_TOKEN:
        description: Turbo token for cache
        required: true
      TURBO_TEAM:
        description: Turbo team for cache
        required: true

env:
  CARGO_TERM_COLOR: always
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ secrets.TURBO_TEAM }}

jobs:
  check_version:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check if version was bumped
        id: check
        run: |
          echo "ðŸ” Changed files:"
          git diff --name-only HEAD^ HEAD || echo "  (none - initial commit)"
          echo ""

          VERSION_BUMPED="false"

          # Check VSCode extension
          VSCODE_PKG="packages/vscode-extension/package.json"
          VSCODE_CURRENT=$(node -p "require('./$VSCODE_PKG').version")
          VSCODE_PREVIOUS=$(git show HEAD^:./$VSCODE_PKG 2>/dev/null | node -p "try { JSON.parse(require('fs').readFileSync('/dev/stdin', 'utf-8')).version } catch(e) { '' }" || echo "")

          echo "ðŸ” VSCode Extension: $VSCODE_PREVIOUS â†’ $VSCODE_CURRENT"
          if [ -n "$VSCODE_PREVIOUS" ] && [ "$VSCODE_PREVIOUS" != "$VSCODE_CURRENT" ]; then
            echo "âœ… VSCode extension version bumped"
            VERSION_BUMPED="true"
          fi

          # Check CLI package
          CLI_PKG="packages/cli/package.json"
          CLI_CURRENT=$(node -p "require('./$CLI_PKG').version")
          CLI_PREVIOUS=$(git show HEAD^:./$CLI_PKG 2>/dev/null | node -p "try { JSON.parse(require('fs').readFileSync('/dev/stdin', 'utf-8')).version } catch(e) { '' }" || echo "")

          echo "ðŸ” CLI: $CLI_PREVIOUS â†’ $CLI_CURRENT"
          if [ -n "$CLI_PREVIOUS" ] && [ "$CLI_PREVIOUS" != "$CLI_CURRENT" ]; then
            echo "âœ… CLI version bumped"
            VERSION_BUMPED="true"
          fi

          echo ""
          if [ "$VERSION_BUMPED" = "true" ]; then
            echo "âœ… Building binaries (version bumped)"
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            echo "â­ï¸  No version bump, skipping binary build"
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

  lint:
    if: inputs.run_lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-and-install

      - name: Run lint
        run: pnpm run lint

      - name: Run format
        run: pnpm run format

      - name: Check if any changes were made
        run: git diff --exit-code

  test-rust:
    if: inputs.run_lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: packages/core/target
          key: ${{ runner.os }}-cargo-build-${{ hashFiles('**/Cargo.lock') }}

      - uses: ./.github/actions/setup-and-install

      - name: Run tests
        run: pnpm turbo run test --filter=core

      - name: Run clippy
        run: pnpm turbo run clippy --filter=core

      - name: Check formatting
        run: pnpm turbo run format:check --filter=core

  build-rust:
    if: inputs.run_build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: packages/core/target
          key: ${{ runner.os }}-cargo-build-release-${{ hashFiles('**/Cargo.lock') }}

      - uses: ./.github/actions/setup-and-install

      - name: Build release
        run: pnpm turbo run build:rust --filter=core

  build:
    if: inputs.run_build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-and-install

      - name: Run typecheck
        run: pnpm run typecheck

      - name: Build package
        run: pnpm run build
